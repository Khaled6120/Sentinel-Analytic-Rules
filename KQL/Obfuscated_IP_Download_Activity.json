{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "workspace": {
      "type": "String"
    }
  },
  "resources": [
    {
      "apiVersion": "2023-02-01-preview",
      "id": "[concat(resourceId('Microsoft.OperationalInsights/workspaces/providers', parameters('workspace'), 'Microsoft.SecurityInsights'),'/alertRules/cb5a2333-56cf-4562-8fcb-22ba1bca728d')]",
      "kind": "Scheduled",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/cb5a2333-56cf-4562-8fcb-22ba1bca728d')]",
      "properties": {
        "alertRuleTemplateName": "cb5a2333-56cf-4562-8fcb-22ba1bca728d",
        "author": "Florian Roth (Nextron Systems), X__Junior (Nextron Systems)",
        "customDetails": null,
        "date": "2022/08/03",
        "description": "Detects use of an encoded/obfuscated version of an IP address (hex, octal...) in an URL combined with a download command",
        "displayName": "Obfuscated IP Download Activity",
        "enabled": true,
        "entityMappings": null,
        "eventGroupingSettings": {
          "aggregationKind": "SingleAlert"
        },
        "logsource": {
          "category": "process_creation",
          "product": "windows"
        },
        "modified": "2023/11/06",
        "query": "DeviceProcessEvents\n| where (ProcessCommandLine contains \"Invoke-WebRequest\" or ProcessCommandLine contains \"iwr \" or ProcessCommandLine contains \"wget \" or ProcessCommandLine contains \"curl \" or ProcessCommandLine contains \"DownloadFile\" or ProcessCommandLine contains \"DownloadString\") and ((ProcessCommandLine contains \" 0x\" or ProcessCommandLine contains \"//0x\" or ProcessCommandLine contains \".0x\" or ProcessCommandLine contains \".00x\") or (ProcessCommandLine contains \"http://%\" and ProcessCommandLine contains \"%2e\") or (ProcessCommandLine matches regex \"https?://[0-9]{1,3}\\\\.[0-9]{1,3}\\\\.0[0-9]{3,4}\" or ProcessCommandLine matches regex \"https?://[0-9]{1,3}\\\\.0[0-9]{3,7}\" or ProcessCommandLine matches regex \"https?://0[0-9]{3,11}\" or ProcessCommandLine matches regex \"https?://(0[0-9]{1,11}\\\\.){3}0[0-9]{1,11}\" or ProcessCommandLine matches regex \"https?://0[0-9]{1,11}\" or ProcessCommandLine matches regex \" [0-7]{7,13}\")) and (not(ProcessCommandLine matches regex \"https?://((25[0-5]|(2[0-4]|1\\\\d|[1-9])?\\\\d)(\\\\.|\\\\b)){4}\"))",
        "queryFrequency": "P1D",
        "queryPeriod": "P1D",
        "sentinelEntitiesMappings": null,
        "severity": "medium",
        "status": "test",
        "suppressionDuration": "PT5H",
        "suppressionEnabled": false,
        "tactics": [
          "discovery"
        ],
        "techniques": [],
        "templateVersion": "1.0.0",
        "triggerThreshold": 0
      },
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules"
    }
  ]
}
