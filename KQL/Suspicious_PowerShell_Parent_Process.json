{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "workspace": {
      "type": "String"
    }
  },
  "resources": [
    {
      "apiVersion": "2023-02-01-preview",
      "id": "[concat(resourceId('Microsoft.OperationalInsights/workspaces/providers', parameters('workspace'), 'Microsoft.SecurityInsights'),'/alertRules/754ed792-634f-40ae-b3bc-e0448d33f695')]",
      "kind": "Scheduled",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/754ed792-634f-40ae-b3bc-e0448d33f695')]",
      "properties": {
        "alertRuleTemplateName": "754ed792-634f-40ae-b3bc-e0448d33f695",
        "author": "Teymur Kheirkhabarov, Harish Segar",
        "customDetails": null,
        "date": "2020/03/20",
        "description": "Detects a suspicious or uncommon parent processes of PowerShell",
        "displayName": "Suspicious PowerShell Parent Process",
        "enabled": true,
        "entityMappings": null,
        "eventGroupingSettings": {
          "aggregationKind": "SingleAlert"
        },
        "logsource": {
          "category": "process_creation",
          "product": "windows"
        },
        "modified": "2023/02/04",
        "query": "DeviceProcessEvents\n| where (InitiatingProcessFolderPath contains \"tomcat\" or (InitiatingProcessFolderPath endswith \"\\\\amigo.exe\" or InitiatingProcessFolderPath endswith \"\\\\browser.exe\" or InitiatingProcessFolderPath endswith \"\\\\chrome.exe\" or InitiatingProcessFolderPath endswith \"\\\\firefox.exe\" or InitiatingProcessFolderPath endswith \"\\\\httpd.exe\" or InitiatingProcessFolderPath endswith \"\\\\iexplore.exe\" or InitiatingProcessFolderPath endswith \"\\\\jbosssvc.exe\" or InitiatingProcessFolderPath endswith \"\\\\microsoftedge.exe\" or InitiatingProcessFolderPath endswith \"\\\\microsoftedgecp.exe\" or InitiatingProcessFolderPath endswith \"\\\\MicrosoftEdgeSH.exe\" or InitiatingProcessFolderPath endswith \"\\\\mshta.exe\" or InitiatingProcessFolderPath endswith \"\\\\nginx.exe\" or InitiatingProcessFolderPath endswith \"\\\\outlook.exe\" or InitiatingProcessFolderPath endswith \"\\\\php-cgi.exe\" or InitiatingProcessFolderPath endswith \"\\\\regsvr32.exe\" or InitiatingProcessFolderPath endswith \"\\\\rundll32.exe\" or InitiatingProcessFolderPath endswith \"\\\\safari.exe\" or InitiatingProcessFolderPath endswith \"\\\\services.exe\" or InitiatingProcessFolderPath endswith \"\\\\sqlagent.exe\" or InitiatingProcessFolderPath endswith \"\\\\sqlserver.exe\" or InitiatingProcessFolderPath endswith \"\\\\sqlservr.exe\" or InitiatingProcessFolderPath endswith \"\\\\vivaldi.exe\" or InitiatingProcessFolderPath endswith \"\\\\w3wp.exe\")) and ((FolderPath endswith \"\\\\powershell.exe\" or FolderPath endswith \"\\\\pwsh.exe\") or (ProcessCommandLine contains \"/c powershell\" or ProcessCommandLine contains \"/c pwsh\") or ProcessVersionInfoFileDescription =~ \"Windows PowerShell\" or ProcessVersionInfoProductName =~ \"PowerShell Core 6\" or (ProcessVersionInfoOriginalFileName in~ (\"PowerShell.EXE\", \"pwsh.dll\")))",
        "queryFrequency": "P1D",
        "queryPeriod": "P1D",
        "sentinelEntitiesMappings": null,
        "severity": "high",
        "status": "test",
        "suppressionDuration": "PT5H",
        "suppressionEnabled": false,
        "tactics": [
          "execution"
        ],
        "techniques": [
          "t1059"
        ],
        "templateVersion": "1.0.0",
        "triggerThreshold": 0
      },
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules"
    }
  ]
}
