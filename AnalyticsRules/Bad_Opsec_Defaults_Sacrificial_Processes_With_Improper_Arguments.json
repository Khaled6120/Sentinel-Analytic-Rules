{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "workspace": {
      "type": "String"
    }
  },
  "resources": [
    {
      "apiVersion": "2023-02-01-preview",
      "id": "[concat(resourceId('Microsoft.OperationalInsights/workspaces/providers', parameters('workspace'), 'Microsoft.SecurityInsights'),'/alertRules/a7c3d773-caef-227e-a7e7-c2f13c622329')]",
      "kind": "Scheduled",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/a7c3d773-caef-227e-a7e7-c2f13c622329')]",
      "properties": {
        "alertRuleTemplateName": "a7c3d773-caef-227e-a7e7-c2f13c622329",
        "author": "Oleg Kolesnikov @securonix invrep_de, oscd.community, Florian Roth (Nextron Systems), Christian Burkard (Nextron Systems)",
        "customDetails": null,
        "date": "2020/10/23",
        "description": "Detects attackers using tooling with bad opsec defaults.\nE.g. spawning a sacrificial process to inject a capability into the process without taking into account how the process is normally run.\nOne trivial example of this is using rundll32.exe without arguments as a sacrificial process (default in CS, now highlighted by c2lint), running WerFault without arguments (Kraken - credit am0nsec), and other examples.\n",
        "displayName": "Bad Opsec Defaults Sacrificial Processes With Improper Arguments",
        "enabled": true,
        "entityMappings": null,
        "eventGroupingSettings": {
          "aggregationKind": "SingleAlert"
        },
        "logsource": {
          "category": "process_creation",
          "product": "windows"
        },
        "modified": "2023/12/02",
        "query": "DeviceProcessEvents\n| where ((ProcessCommandLine endswith \"regasm.exe\" and FolderPath endswith \"\\\\regasm.exe\") or (ProcessCommandLine endswith \"regsvcs.exe\" and FolderPath endswith \"\\\\regsvcs.exe\") or (ProcessCommandLine endswith \"regsvr32.exe\" and FolderPath endswith \"\\\\regsvr32.exe\") or (ProcessCommandLine endswith \"rundll32.exe\" and FolderPath endswith \"\\\\rundll32.exe\") or (ProcessCommandLine endswith \"WerFault.exe\" and FolderPath endswith \"\\\\WerFault.exe\")) and (not((InitiatingProcessFolderPath contains \":\\\\Users\\\\\" and InitiatingProcessFolderPath contains \"\\\\AppData\\\\Local\\\\Microsoft\\\\EdgeUpdate\\\\Install\\\\{\"))) and (not((ProcessCommandLine endswith \"rundll32.exe\" and FolderPath endswith \"\\\\rundll32.exe\" and InitiatingProcessCommandLine contains \"--uninstall --channel=stable\" and (InitiatingProcessFolderPath contains \":\\\\Users\\\\\" and InitiatingProcessFolderPath contains \"\\\\AppData\\\\Local\\\\Google\\\\Chrome\\\\Application\\\\\") and InitiatingProcessFolderPath endswith \"\\\\Installer\\\\setup.exe\")))",
        "queryFrequency": "P1D",
        "queryPeriod": "P1D",
        "sentinelEntitiesMappings": null,
        "severity": "high",
        "status": "experimental",
        "suppressionDuration": "PT5H",
        "suppressionEnabled": false,
        "tactics": null,
        "techniques": [
          "t1218"
        ],
        "templateVersion": "1.0.0",
        "triggerThreshold": 0
      },
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules"
    }
  ]
}
