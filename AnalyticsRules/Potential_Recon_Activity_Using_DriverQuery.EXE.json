{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "workspace": {
      "type": "String"
    }
  },
  "resources": [
    {
      "apiVersion": "2023-02-01-preview",
      "id": "[concat(resourceId('Microsoft.OperationalInsights/workspaces/providers', parameters('workspace'), 'Microsoft.SecurityInsights'),'/alertRules/9fc3072c-dc8f-4bf7-b231-18950000fadd')]",
      "kind": "Scheduled",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/9fc3072c-dc8f-4bf7-b231-18950000fadd')]",
      "properties": {
        "alertRuleTemplateName": "9fc3072c-dc8f-4bf7-b231-18950000fadd",
        "author": "Nasreddine Bencherchali (Nextron Systems)",
        "customDetails": null,
        "date": "2023/01/19",
        "description": "Detect usage of the \"driverquery\" utility to perform reconnaissance on installed drivers",
        "displayName": "Potential Recon Activity Using DriverQuery.EXE",
        "enabled": true,
        "entityMappings": null,
        "eventGroupingSettings": {
          "aggregationKind": "SingleAlert"
        },
        "logsource": {
          "category": "process_creation",
          "product": "windows"
        },
        "modified": "2023/09/29",
        "query": "DeviceProcessEvents\n| where (FolderPath endswith \"driverquery.exe\" or ProcessVersionInfoOriginalFileName =~ \"drvqry.exe\") and ((InitiatingProcessFolderPath endswith \"\\\\cscript.exe\" or InitiatingProcessFolderPath endswith \"\\\\mshta.exe\" or InitiatingProcessFolderPath endswith \"\\\\regsvr32.exe\" or InitiatingProcessFolderPath endswith \"\\\\rundll32.exe\" or InitiatingProcessFolderPath endswith \"\\\\wscript.exe\") or (InitiatingProcessFolderPath contains \"\\\\AppData\\\\Local\\\\\" or InitiatingProcessFolderPath contains \"\\\\Users\\\\Public\\\\\" or InitiatingProcessFolderPath contains \"\\\\Windows\\\\Temp\\\\\"))",
        "queryFrequency": "P1D",
        "queryPeriod": "P1D",
        "sentinelEntitiesMappings": null,
        "severity": "high",
        "status": "experimental",
        "suppressionDuration": "PT5H",
        "suppressionEnabled": false,
        "tactics": [
          "discovery"
        ],
        "techniques": [],
        "templateVersion": "1.0.0",
        "triggerThreshold": 0
      },
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules"
    }
  ]
}
