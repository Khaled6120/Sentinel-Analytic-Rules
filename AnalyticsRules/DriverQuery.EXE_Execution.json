{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "workspace": {
      "type": "String"
    }
  },
  "resources": [
    {
      "apiVersion": "2023-02-01-preview",
      "id": "[concat(resourceId('Microsoft.OperationalInsights/workspaces/providers', parameters('workspace'), 'Microsoft.SecurityInsights'),'/alertRules/a20def93-0709-4eae-9bd2-31206e21e6b2')]",
      "kind": "Scheduled",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/a20def93-0709-4eae-9bd2-31206e21e6b2')]",
      "properties": {
        "alertRuleTemplateName": "a20def93-0709-4eae-9bd2-31206e21e6b2",
        "author": "Nasreddine Bencherchali (Nextron Systems)",
        "customDetails": null,
        "date": "2023/01/19",
        "description": "Detect usage of the \"driverquery\" utility. Which can be used to perform reconnaissance on installed drivers",
        "displayName": "DriverQuery.EXE Execution",
        "enabled": true,
        "entityMappings": null,
        "eventGroupingSettings": {
          "aggregationKind": "SingleAlert"
        },
        "logsource": {
          "category": "process_creation",
          "product": "windows"
        },
        "modified": "2023/09/29",
        "query": "DeviceProcessEvents\n| where (FolderPath endswith \"driverquery.exe\" or ProcessVersionInfoOriginalFileName =~ \"drvqry.exe\") and (not(((InitiatingProcessFolderPath endswith \"\\\\cscript.exe\" or InitiatingProcessFolderPath endswith \"\\\\mshta.exe\" or InitiatingProcessFolderPath endswith \"\\\\regsvr32.exe\" or InitiatingProcessFolderPath endswith \"\\\\rundll32.exe\" or InitiatingProcessFolderPath endswith \"\\\\wscript.exe\") or (InitiatingProcessFolderPath contains \"\\\\AppData\\\\Local\\\\\" or InitiatingProcessFolderPath contains \"\\\\Users\\\\Public\\\\\" or InitiatingProcessFolderPath contains \"\\\\Windows\\\\Temp\\\\\"))))",
        "queryFrequency": "P1D",
        "queryPeriod": "P1D",
        "sentinelEntitiesMappings": null,
        "severity": "medium",
        "status": "experimental",
        "suppressionDuration": "PT5H",
        "suppressionEnabled": false,
        "tactics": [
          "Discovery"
        ],
        "techniques": [],
        "templateVersion": "1.0.0",
        "triggerOperator": "GreaterThan",
        "triggerThreshold": 0
      },
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules"
    }
  ]
}
