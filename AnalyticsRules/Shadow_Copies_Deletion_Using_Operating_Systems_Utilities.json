{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "workspace": {
      "type": "String"
    }
  },
  "resources": [
    {
      "apiVersion": "2023-02-01-preview",
      "id": "[concat(resourceId('Microsoft.OperationalInsights/workspaces/providers', parameters('workspace'), 'Microsoft.SecurityInsights'),'/alertRules/c947b146-0abc-4c87-9c64-b17e9d7274a2')]",
      "kind": "NRT",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/c947b146-0abc-4c87-9c64-b17e9d7274a2')]",
      "properties": {
        "alertRuleTemplateName": "c947b146-0abc-4c87-9c64-b17e9d7274a2",
        "author": "Florian Roth (Nextron Systems), Michael Haag, Teymur Kheirkhabarov, Daniil Yugoslavskiy, oscd.community, Andreas Hunkeler (@Karneades)",
        "customDetails": null,
        "date": "2019/10/22",
        "description": "Shadow Copies deletion using operating systems utilities",
        "displayName": "Shadow Copies Deletion Using Operating Systems Utilities",
        "enabled": true,
        "entityMappings": null,
        "eventGroupingSettings": {
          "aggregationKind": "SingleAlert"
        },
        "logsource": {
          "category": "process_creation",
          "product": "windows"
        },
        "modified": "2022/11/03",
        "query": "DeviceProcessEvents\n| where ((ProcessCommandLine contains \"shadow\" and ProcessCommandLine contains \"delete\") and ((FolderPath endswith \"\\\\powershell.exe\" or FolderPath endswith \"\\\\pwsh.exe\" or FolderPath endswith \"\\\\wmic.exe\" or FolderPath endswith \"\\\\vssadmin.exe\" or FolderPath endswith \"\\\\diskshadow.exe\") or (ProcessVersionInfoOriginalFileName in~ (\"PowerShell.EXE\", \"pwsh.dll\", \"wmic.exe\", \"VSSADMIN.EXE\", \"diskshadow.exe\")))) or ((ProcessCommandLine contains \"delete\" and ProcessCommandLine contains \"catalog\" and ProcessCommandLine contains \"quiet\") and (FolderPath endswith \"\\\\wbadmin.exe\" or ProcessVersionInfoOriginalFileName =~ \"WBADMIN.EXE\")) or (((ProcessCommandLine contains \"unbounded\" or ProcessCommandLine contains \"/MaxSize=\") and (ProcessCommandLine contains \"resize\" and ProcessCommandLine contains \"shadowstorage\")) and (FolderPath endswith \"\\\\vssadmin.exe\" or ProcessVersionInfoOriginalFileName =~ \"VSSADMIN.EXE\"))",
        "queryFrequency": "P1D",
        "queryPeriod": "P1D",
        "sentinelEntitiesMappings": null,
        "severity": "high",
        "status": "stable",
        "suppressionDuration": "PT5H",
        "suppressionEnabled": false,
        "tactics": [
          "impact"
        ],
        "techniques": [
          "t1070",
          "t1490"
        ],
        "templateVersion": "1.0.0",
        "triggerOperator": "GreaterThan",
        "triggerThreshold": 0
      },
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules"
    }
  ]
}
