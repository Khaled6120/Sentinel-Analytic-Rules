{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "workspace": {
      "type": "String"
    }
  },
  "resources": [
    {
      "apiVersion": "2023-02-01-preview",
      "id": "[concat(resourceId('Microsoft.OperationalInsights/workspaces/providers', parameters('workspace'), 'Microsoft.SecurityInsights'),'/alertRules/17a1be64-8d88-40bf-b5ff-a4f7a50ebcc8')]",
      "kind": "Scheduled",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/17a1be64-8d88-40bf-b5ff-a4f7a50ebcc8')]",
      "properties": {
        "alertRuleTemplateName": "17a1be64-8d88-40bf-b5ff-a4f7a50ebcc8",
        "author": "Nasreddine Bencherchali (Nextron Systems)",
        "customDetails": null,
        "date": "2022/07/14",
        "description": "Detects creation of a new service via \"sc\" command or the powershell \"new-service\" cmdlet with suspicious binary paths",
        "displayName": "Suspicious New Service Creation",
        "enabled": true,
        "entityMappings": null,
        "eventGroupingSettings": {
          "aggregationKind": "SingleAlert"
        },
        "logsource": {
          "category": "process_creation",
          "product": "windows"
        },
        "modified": "2022/11/18",
        "query": "DeviceProcessEvents\n| where ((ProcessCommandLine contains \"New-Service\" and ProcessCommandLine contains \"-BinaryPathName\") or ((ProcessCommandLine contains \"create\" and ProcessCommandLine contains \"binPath=\") and FolderPath endswith \"\\\\sc.exe\")) and (ProcessCommandLine contains \"powershell\" or ProcessCommandLine contains \"mshta\" or ProcessCommandLine contains \"wscript\" or ProcessCommandLine contains \"cscript\" or ProcessCommandLine contains \"svchost\" or ProcessCommandLine contains \"dllhost\" or ProcessCommandLine contains \"cmd \" or ProcessCommandLine contains \"cmd.exe /c\" or ProcessCommandLine contains \"cmd.exe /k\" or ProcessCommandLine contains \"cmd.exe /r\" or ProcessCommandLine contains \"rundll32\" or ProcessCommandLine contains \"C:\\\\Users\\\\Public\" or ProcessCommandLine contains \"\\\\Downloads\\\\\" or ProcessCommandLine contains \"\\\\Desktop\\\\\" or ProcessCommandLine contains \"\\\\Microsoft\\\\Windows\\\\Start Menu\\\\Programs\\\\Startup\\\\\" or ProcessCommandLine contains \"C:\\\\Windows\\\\TEMP\\\\\" or ProcessCommandLine contains \"\\\\AppData\\\\Local\\\\Temp\")",
        "queryFrequency": "P1D",
        "queryPeriod": "P1D",
        "sentinelEntitiesMappings": null,
        "severity": "high",
        "status": "test",
        "suppressionDuration": "PT5H",
        "suppressionEnabled": false,
        "tactics": [
          "Persistence"
        ],
        "techniques": [
          "T1543"
        ],
        "templateVersion": "1.0.0",
        "triggerOperator": "GreaterThan",
        "triggerThreshold": 0
      },
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules"
    }
  ]
}
