{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "workspace": {
      "type": "String"
    }
  },
  "resources": [
    {
      "apiVersion": "2023-02-01-preview",
      "id": "[concat(resourceId('Microsoft.OperationalInsights/workspaces/providers', parameters('workspace'), 'Microsoft.SecurityInsights'),'/alertRules/8a582fe2-0882-4b89-a82a-da6b2dc32937')]",
      "kind": "Scheduled",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/8a582fe2-0882-4b89-a82a-da6b2dc32937')]",
      "properties": {
        "alertRuleTemplateName": "8a582fe2-0882-4b89-a82a-da6b2dc32937",
        "author": "Vadim Khrykov (ThreatIntel), Cyb3rEng, Florian Roth (Nextron Systems)",
        "customDetails": null,
        "date": "2021/08/23",
        "description": "Detects suspicious and uncommon child processes of WmiPrvSE",
        "displayName": "Suspicious WmiPrvSE Child Process",
        "enabled": true,
        "entityMappings": null,
        "eventGroupingSettings": {
          "aggregationKind": "SingleAlert"
        },
        "logsource": {
          "category": "process_creation",
          "product": "windows"
        },
        "modified": "2023/11/10",
        "query": "DeviceProcessEvents\n| where InitiatingProcessFolderPath endswith \"\\\\wbem\\\\WmiPrvSE.exe\" and ((FolderPath endswith \"\\\\certutil.exe\" or FolderPath endswith \"\\\\cscript.exe\" or FolderPath endswith \"\\\\mshta.exe\" or FolderPath endswith \"\\\\msiexec.exe\" or FolderPath endswith \"\\\\regsvr32.exe\" or FolderPath endswith \"\\\\rundll32.exe\" or FolderPath endswith \"\\\\verclsid.exe\" or FolderPath endswith \"\\\\wscript.exe\") or ((ProcessCommandLine contains \"cscript\" or ProcessCommandLine contains \"mshta\" or ProcessCommandLine contains \"powershell\" or ProcessCommandLine contains \"pwsh\" or ProcessCommandLine contains \"regsvr32\" or ProcessCommandLine contains \"rundll32\" or ProcessCommandLine contains \"wscript\") and FolderPath endswith \"\\\\cmd.exe\")) and (not(((ProcessCommandLine contains \"/i \" and FolderPath endswith \"\\\\msiexec.exe\") or FolderPath endswith \"\\\\WerFault.exe\" or FolderPath endswith \"\\\\WmiPrvSE.exe\")))",
        "queryFrequency": "P1D",
        "queryPeriod": "P1D",
        "sentinelEntitiesMappings": null,
        "severity": "high",
        "status": "test",
        "suppressionDuration": "PT5H",
        "suppressionEnabled": false,
        "tactics": [
          "execution"
        ],
        "techniques": [
          "t1047",
          "t1204",
          "t1218"
        ],
        "templateVersion": "1.0.0",
        "triggerThreshold": 0
      },
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules"
    }
  ]
}
