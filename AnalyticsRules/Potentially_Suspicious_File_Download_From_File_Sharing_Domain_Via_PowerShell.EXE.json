{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "workspace": {
      "type": "String"
    }
  },
  "resources": [
    {
      "apiVersion": "2023-02-01-preview",
      "id": "[concat(resourceId('Microsoft.OperationalInsights/workspaces/providers', parameters('workspace'), 'Microsoft.SecurityInsights'),'/alertRules/b6e04788-29e1-4557-bb14-77f761848ab8')]",
      "kind": "Scheduled",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/b6e04788-29e1-4557-bb14-77f761848ab8')]",
      "properties": {
        "alertRuleTemplateName": "b6e04788-29e1-4557-bb14-77f761848ab8",
        "author": "Nasreddine Bencherchali (Nextron Systems)",
        "customDetails": null,
        "date": "2024/02/23",
        "description": "Detects potentially suspicious file downloads from file sharing domains using PowerShell.exe",
        "displayName": "Potentially Suspicious File Download From File Sharing Domain Via PowerShell.EXE",
        "enabled": true,
        "entityMappings": null,
        "eventGroupingSettings": {
          "aggregationKind": "SingleAlert"
        },
        "logsource": {
          "category": "process_creation",
          "product": "windows"
        },
        "modified": "",
        "query": "DeviceProcessEvents\n| where (ProcessCommandLine contains \".DownloadString(\" or ProcessCommandLine contains \".DownloadFile(\" or ProcessCommandLine contains \"Invoke-WebRequest \" or ProcessCommandLine contains \"iwr \" or ProcessCommandLine contains \"wget \") and ((FolderPath endswith \"\\\\powershell.exe\" or FolderPath endswith \"\\\\pwsh.exe\") or (ProcessVersionInfoOriginalFileName in~ (\"PowerShell.EXE\", \"pwsh.dll\"))) and (ProcessCommandLine contains \"anonfiles.com\" or ProcessCommandLine contains \"cdn.discordapp.com\" or ProcessCommandLine contains \"cdn.discordapp.com/attachments/\" or ProcessCommandLine contains \"ddns.net\" or ProcessCommandLine contains \"dl.dropboxusercontent.com\" or ProcessCommandLine contains \"ghostbin.co\" or ProcessCommandLine contains \"glitch.me\" or ProcessCommandLine contains \"gofile.io\" or ProcessCommandLine contains \"hastebin.com\" or ProcessCommandLine contains \"mediafire.com\" or ProcessCommandLine contains \"mega.nz\" or ProcessCommandLine contains \"onrender.com\" or ProcessCommandLine contains \"paste.ee\" or ProcessCommandLine contains \"pastebin.com\" or ProcessCommandLine contains \"pastebin.pl\" or ProcessCommandLine contains \"pastetext.net\" or ProcessCommandLine contains \"privatlab.com\" or ProcessCommandLine contains \"privatlab.net\" or ProcessCommandLine contains \"send.exploit.in\" or ProcessCommandLine contains \"sendspace.com\" or ProcessCommandLine contains \"storage.googleapis.com\" or ProcessCommandLine contains \"storjshare.io\" or ProcessCommandLine contains \"supabase.co\" or ProcessCommandLine contains \"temp.sh\" or ProcessCommandLine contains \"transfer.sh\" or ProcessCommandLine contains \"ufile.io\")",
        "queryFrequency": "P1D",
        "queryPeriod": "P1D",
        "sentinelEntitiesMappings": null,
        "severity": "high",
        "status": "experimental",
        "suppressionDuration": "PT5H",
        "suppressionEnabled": false,
        "tactics": [
          "execution"
        ],
        "techniques": [],
        "templateVersion": "1.0.0",
        "triggerThreshold": 0
      },
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules"
    }
  ]
}
