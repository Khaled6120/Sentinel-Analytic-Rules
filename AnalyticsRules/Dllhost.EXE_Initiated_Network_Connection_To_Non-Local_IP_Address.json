{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "workspace": {
      "type": "String"
    }
  },
  "resources": [
    {
      "apiVersion": "2023-02-01-preview",
      "id": "[concat(resourceId('Microsoft.OperationalInsights/workspaces/providers', parameters('workspace'), 'Microsoft.SecurityInsights'),'/alertRules/cfed2f44-16df-4bf3-833a-79405198b277')]",
      "kind": "Scheduled",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/cfed2f44-16df-4bf3-833a-79405198b277')]",
      "properties": {
        "alertRuleTemplateName": "cfed2f44-16df-4bf3-833a-79405198b277",
        "author": "bartblaze",
        "customDetails": null,
        "date": "2020/07/13",
        "description": "Detects dllhost initiating a network connection to a non-local IP address.\nAside from Microsoft own IP range that needs to be excluded. Network communication from Dllhost will depend entirely on the hosted DLL.\nAn initial baseline is recommended before deployment.\n",
        "displayName": "Dllhost.EXE Initiated Network Connection To Non-Local IP Address",
        "enabled": true,
        "entityMappings": null,
        "eventGroupingSettings": {
          "aggregationKind": "SingleAlert"
        },
        "logsource": {
          "category": "network_connection",
          "product": "windows"
        },
        "modified": "2024/03/12",
        "query": "DeviceNetworkEvents\n| where InitiatingProcessFolderPath endswith \"\\\\dllhost.exe\" and (not(((ipv4_is_in_range(RemoteIP, \"::1/128\") or ipv4_is_in_range(RemoteIP, \"10.0.0.0/8\") or ipv4_is_in_range(RemoteIP, \"127.0.0.0/8\") or ipv4_is_in_range(RemoteIP, \"172.16.0.0/12\") or ipv4_is_in_range(RemoteIP, \"192.168.0.0/16\") or ipv4_is_in_range(RemoteIP, \"169.254.0.0/16\") or ipv4_is_in_range(RemoteIP, \"fc00::/7\") or ipv4_is_in_range(RemoteIP, \"fe80::/10\")) or (ipv4_is_in_range(RemoteIP, \"20.184.0.0/13\") or ipv4_is_in_range(RemoteIP, \"20.192.0.0/10\") or ipv4_is_in_range(RemoteIP, \"23.72.0.0/13\") or ipv4_is_in_range(RemoteIP, \"51.10.0.0/15\") or ipv4_is_in_range(RemoteIP, \"51.103.0.0/16\") or ipv4_is_in_range(RemoteIP, \"51.104.0.0/15\") or ipv4_is_in_range(RemoteIP, \"52.224.0.0/11\") or ipv4_is_in_range(RemoteIP, \"204.79.197.0/24\")))))",
        "queryFrequency": "P1D",
        "queryPeriod": "P1D",
        "sentinelEntitiesMappings": null,
        "severity": "medium",
        "status": "test",
        "suppressionDuration": "PT5H",
        "suppressionEnabled": false,
        "tactics": [
          "execution"
        ],
        "techniques": [
          "T1218",
          "T1559"
        ],
        "templateVersion": "1.0.0",
        "triggerOperator": "GreaterThan",
        "triggerThreshold": 0
      },
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules"
    }
  ]
}
