{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "workspace": {
      "type": "String"
    }
  },
  "resources": [
    {
      "apiVersion": "2023-02-01-preview",
      "id": "[concat(resourceId('Microsoft.OperationalInsights/workspaces/providers', parameters('workspace'), 'Microsoft.SecurityInsights'),'/alertRules/e4b6d2a7-d8a4-4f19-acbd-943c16d90647')]",
      "kind": "Scheduled",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/e4b6d2a7-d8a4-4f19-acbd-943c16d90647')]",
      "properties": {
        "alertRuleTemplateName": "e4b6d2a7-d8a4-4f19-acbd-943c16d90647",
        "author": "Florian Roth (Nextron Systems), Tim Shelton",
        "customDetails": null,
        "date": "2022/04/26",
        "description": "Detects potentially suspicious child processes spawned by PowerShell",
        "displayName": "Potentially Suspicious PowerShell Child Processes",
        "enabled": true,
        "entityMappings": null,
        "eventGroupingSettings": {
          "aggregationKind": "SingleAlert"
        },
        "logsource": {
          "category": "process_creation",
          "product": "windows"
        },
        "modified": "2023/05/30",
        "query": "DeviceProcessEvents\n| where ((FolderPath endswith \"\\\\bash.exe\" or FolderPath endswith \"\\\\bitsadmin.exe\" or FolderPath endswith \"\\\\certutil.exe\" or FolderPath endswith \"\\\\cscript.exe\" or FolderPath endswith \"\\\\forfiles.exe\" or FolderPath endswith \"\\\\hh.exe\" or FolderPath endswith \"\\\\mshta.exe\" or FolderPath endswith \"\\\\regsvr32.exe\" or FolderPath endswith \"\\\\rundll32.exe\" or FolderPath endswith \"\\\\schtasks.exe\" or FolderPath endswith \"\\\\scrcons.exe\" or FolderPath endswith \"\\\\scriptrunner.exe\" or FolderPath endswith \"\\\\sh.exe\" or FolderPath endswith \"\\\\wmic.exe\" or FolderPath endswith \"\\\\wscript.exe\") and (InitiatingProcessFolderPath endswith \"\\\\powershell_ise.exe\" or InitiatingProcessFolderPath endswith \"\\\\powershell.exe\" or InitiatingProcessFolderPath endswith \"\\\\pwsh.exe\")) and (not((ProcessCommandLine contains \"\\\\Program Files\\\\Amazon\\\\WorkspacesConfig\\\\Scripts\\\\\" and InitiatingProcessCommandLine contains \"\\\\Program Files\\\\Amazon\\\\WorkspacesConfig\\\\Scripts\\\\\")))",
        "queryFrequency": "P1D",
        "queryPeriod": "P1D",
        "sentinelEntitiesMappings": null,
        "severity": "high",
        "status": "test",
        "suppressionDuration": "PT5H",
        "suppressionEnabled": false,
        "tactics": [
          "Execution"
        ],
        "techniques": [
          "T1059"
        ],
        "templateVersion": "1.0.0",
        "triggerOperator": "GreaterThan",
        "triggerThreshold": 0
      },
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules"
    }
  ]
}
