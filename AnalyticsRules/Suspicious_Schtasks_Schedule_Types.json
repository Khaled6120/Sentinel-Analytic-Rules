{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "workspace": {
      "type": "String"
    }
  },
  "resources": [
    {
      "apiVersion": "2023-02-01-preview",
      "id": "[concat(resourceId('Microsoft.OperationalInsights/workspaces/providers', parameters('workspace'), 'Microsoft.SecurityInsights'),'/alertRules/24c8392b-aa3c-46b7-a545-43f71657fe98')]",
      "kind": "Scheduled",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/24c8392b-aa3c-46b7-a545-43f71657fe98')]",
      "properties": {
        "alertRuleTemplateName": "24c8392b-aa3c-46b7-a545-43f71657fe98",
        "author": "Nasreddine Bencherchali (Nextron Systems)",
        "customDetails": null,
        "date": "2022/09/09",
        "description": "Detects scheduled task creations or modification on a suspicious schedule type",
        "displayName": "Suspicious Schtasks Schedule Types",
        "enabled": true,
        "entityMappings": null,
        "eventGroupingSettings": {
          "aggregationKind": "SingleAlert"
        },
        "logsource": {
          "category": "process_creation",
          "product": "windows"
        },
        "modified": "",
        "query": "DeviceProcessEvents\n| where ((FolderPath endswith \"\\\\schtasks.exe\" or ProcessVersionInfoOriginalFileName =~ \"schtasks.exe\") and (ProcessCommandLine contains \" ONLOGON \" or ProcessCommandLine contains \" ONSTART \" or ProcessCommandLine contains \" ONCE \" or ProcessCommandLine contains \" ONIDLE \")) and (not((ProcessCommandLine contains \"NT AUT\" or ProcessCommandLine contains \" SYSTEM\" or ProcessCommandLine contains \"HIGHEST\")))",
        "queryFrequency": "P1D",
        "queryPeriod": "P1D",
        "sentinelEntitiesMappings": null,
        "severity": "high",
        "status": "test",
        "suppressionDuration": "PT5H",
        "suppressionEnabled": false,
        "tactics": [
          "Execution"
        ],
        "techniques": [
          "T1053"
        ],
        "templateVersion": "1.0.0",
        "triggerOperator": "GreaterThan",
        "triggerThreshold": 0
      },
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules"
    }
  ]
}
