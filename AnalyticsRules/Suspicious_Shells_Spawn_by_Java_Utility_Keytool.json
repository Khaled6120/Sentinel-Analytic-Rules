{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "workspace": {
      "type": "String"
    }
  },
  "resources": [
    {
      "apiVersion": "2023-02-01-preview",
      "id": "[concat(resourceId('Microsoft.OperationalInsights/workspaces/providers', parameters('workspace'), 'Microsoft.SecurityInsights'),'/alertRules/90fb5e62-ca1f-4e22-b42e-cc521874c938')]",
      "kind": "NRT",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/90fb5e62-ca1f-4e22-b42e-cc521874c938')]",
      "properties": {
        "alertRuleTemplateName": "90fb5e62-ca1f-4e22-b42e-cc521874c938",
        "author": "Andreas Hunkeler (@Karneades)",
        "customDetails": null,
        "date": "2021/12/22",
        "description": "Detects suspicious shell spawn from Java utility keytool process (e.g. adselfservice plus exploitation)",
        "displayName": "Suspicious Shells Spawn by Java Utility Keytool",
        "enabled": true,
        "entityMappings": null,
        "eventGroupingSettings": {
          "aggregationKind": "SingleAlert"
        },
        "logsource": {
          "category": "process_creation",
          "product": "windows"
        },
        "modified": "2023/01/21",
        "query": "DeviceProcessEvents\n| where (FolderPath endswith \"\\\\cmd.exe\" or FolderPath endswith \"\\\\sh.exe\" or FolderPath endswith \"\\\\bash.exe\" or FolderPath endswith \"\\\\powershell.exe\" or FolderPath endswith \"\\\\pwsh.exe\" or FolderPath endswith \"\\\\schtasks.exe\" or FolderPath endswith \"\\\\certutil.exe\" or FolderPath endswith \"\\\\whoami.exe\" or FolderPath endswith \"\\\\bitsadmin.exe\" or FolderPath endswith \"\\\\wscript.exe\" or FolderPath endswith \"\\\\cscript.exe\" or FolderPath endswith \"\\\\scrcons.exe\" or FolderPath endswith \"\\\\regsvr32.exe\" or FolderPath endswith \"\\\\hh.exe\" or FolderPath endswith \"\\\\wmic.exe\" or FolderPath endswith \"\\\\mshta.exe\" or FolderPath endswith \"\\\\rundll32.exe\" or FolderPath endswith \"\\\\forfiles.exe\" or FolderPath endswith \"\\\\scriptrunner.exe\" or FolderPath endswith \"\\\\mftrace.exe\" or FolderPath endswith \"\\\\AppVLP.exe\" or FolderPath endswith \"\\\\systeminfo.exe\" or FolderPath endswith \"\\\\reg.exe\" or FolderPath endswith \"\\\\query.exe\") and InitiatingProcessFolderPath endswith \"\\\\keytool.exe\"",
        "queryFrequency": "P1D",
        "queryPeriod": "P1D",
        "sentinelEntitiesMappings": null,
        "severity": "high",
        "status": "test",
        "suppressionDuration": "PT5H",
        "suppressionEnabled": false,
        "tactics": [
          "persistence"
        ],
        "techniques": [],
        "templateVersion": "1.0.0",
        "triggerOperator": "GreaterThan",
        "triggerThreshold": 0
      },
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules"
    }
  ]
}
