{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "workspace": {
      "type": "String"
    }
  },
  "resources": [
    {
      "apiVersion": "2023-02-01-preview",
      "id": "[concat(resourceId('Microsoft.OperationalInsights/workspaces/providers', parameters('workspace'), 'Microsoft.SecurityInsights'),'/alertRules/5589ab4f-a767-433c-961d-c91f3f704db1')]",
      "kind": "NRT",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/5589ab4f-a767-433c-961d-c91f3f704db1')]",
      "properties": {
        "alertRuleTemplateName": "5589ab4f-a767-433c-961d-c91f3f704db1",
        "author": "Florian Roth (Nextron Systems)",
        "customDetails": null,
        "date": "2021/07/24",
        "description": "Detects different hacktools used for relay attacks on Windows for privilege escalation",
        "displayName": "Potential SMB Relay Attack Tool Execution",
        "enabled": true,
        "entityMappings": null,
        "eventGroupingSettings": {
          "aggregationKind": "SingleAlert"
        },
        "logsource": {
          "category": "process_creation",
          "product": "windows"
        },
        "modified": "2023/02/14",
        "query": "DeviceProcessEvents\n| where ((ProcessCommandLine contains \".exe -c \\\"{\" and ProcessCommandLine endswith \"}\\\" -z\") or (FolderPath contains \"PetitPotam\" or FolderPath contains \"RottenPotato\" or FolderPath contains \"HotPotato\" or FolderPath contains \"JuicyPotato\" or FolderPath contains \"\\\\just_dce_\" or FolderPath contains \"Juicy Potato\" or FolderPath contains \"\\\\temp\\\\rot.exe\" or FolderPath contains \"\\\\Potato.exe\" or FolderPath contains \"\\\\SpoolSample.exe\" or FolderPath contains \"\\\\Responder.exe\" or FolderPath contains \"\\\\smbrelayx\" or FolderPath contains \"\\\\ntlmrelayx\" or FolderPath contains \"\\\\LocalPotato\") or (ProcessCommandLine contains \"Invoke-Tater\" or ProcessCommandLine contains \" smbrelay\" or ProcessCommandLine contains \" ntlmrelay\" or ProcessCommandLine contains \"cme smb \" or ProcessCommandLine contains \" /ntlm:NTLMhash \" or ProcessCommandLine contains \"Invoke-PetitPotam\" or (ProcessCommandLine contains \".exe -t \" and ProcessCommandLine contains \" -p \"))) and (not((FolderPath contains \"HotPotatoes6\" or FolderPath contains \"HotPotatoes7\" or FolderPath contains \"HotPotatoes \")))",
        "queryFrequency": "P1D",
        "queryPeriod": "P1D",
        "sentinelEntitiesMappings": null,
        "severity": "critical",
        "status": "test",
        "suppressionDuration": "PT5H",
        "suppressionEnabled": false,
        "tactics": [
          "execution"
        ],
        "techniques": [
          "t1557"
        ],
        "templateVersion": "1.0.0",
        "triggerOperator": "GreaterThan",
        "triggerThreshold": 0
      },
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules"
    }
  ]
}
