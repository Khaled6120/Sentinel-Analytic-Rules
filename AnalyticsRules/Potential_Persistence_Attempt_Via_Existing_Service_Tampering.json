{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "workspace": {
      "type": "String"
    }
  },
  "resources": [
    {
      "apiVersion": "2023-02-01-preview",
      "id": "[concat(resourceId('Microsoft.OperationalInsights/workspaces/providers', parameters('workspace'), 'Microsoft.SecurityInsights'),'/alertRules/38879043-7e1e-47a9-8d46-6bec88e201df')]",
      "kind": "Scheduled",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/38879043-7e1e-47a9-8d46-6bec88e201df')]",
      "properties": {
        "alertRuleTemplateName": "38879043-7e1e-47a9-8d46-6bec88e201df",
        "author": "Sreeman",
        "customDetails": null,
        "date": "2020/09/29",
        "description": "Detects the modification of an existing service in order to execute an arbitrary payload when the service is started or killed as a potential method for persistence.",
        "displayName": "Potential Persistence Attempt Via Existing Service Tampering",
        "enabled": true,
        "entityMappings": null,
        "eventGroupingSettings": {
          "aggregationKind": "SingleAlert"
        },
        "logsource": {
          "category": "process_creation",
          "product": "windows"
        },
        "modified": "2023/02/04",
        "query": "DeviceProcessEvents\n| where ((ProcessCommandLine contains \"sc \" and ProcessCommandLine contains \"config \" and ProcessCommandLine contains \"binpath=\") or (ProcessCommandLine contains \"sc \" and ProcessCommandLine contains \"failure\" and ProcessCommandLine contains \"command=\")) or ((ProcessCommandLine contains \".sh\" or ProcessCommandLine contains \".exe\" or ProcessCommandLine contains \".dll\" or ProcessCommandLine contains \".bin$\" or ProcessCommandLine contains \".bat\" or ProcessCommandLine contains \".cmd\" or ProcessCommandLine contains \".js\" or ProcessCommandLine contains \".msh$\" or ProcessCommandLine contains \".reg$\" or ProcessCommandLine contains \".scr\" or ProcessCommandLine contains \".ps\" or ProcessCommandLine contains \".vb\" or ProcessCommandLine contains \".jar\" or ProcessCommandLine contains \".pl\") and ((ProcessCommandLine contains \"reg \" and ProcessCommandLine contains \"add \" and ProcessCommandLine contains \"FailureCommand\") or (ProcessCommandLine contains \"reg \" and ProcessCommandLine contains \"add \" and ProcessCommandLine contains \"ImagePath\")))",
        "queryFrequency": "P1D",
        "queryPeriod": "P1D",
        "sentinelEntitiesMappings": null,
        "severity": "medium",
        "status": "test",
        "suppressionDuration": "PT5H",
        "suppressionEnabled": false,
        "tactics": [
          "persistence"
        ],
        "techniques": [
          "T1543",
          "T1574"
        ],
        "templateVersion": "1.0.0",
        "triggerOperator": "GreaterThan",
        "triggerThreshold": 0
      },
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules"
    }
  ]
}
