{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "workspace": {
      "type": "String"
    }
  },
  "resources": [
    {
      "apiVersion": "2023-02-01-preview",
      "id": "[concat(resourceId('Microsoft.OperationalInsights/workspaces/providers', parameters('workspace'), 'Microsoft.SecurityInsights'),'/alertRules/01aeb693-138d-49d2-9403-c4f52d7d3d62')]",
      "kind": "Scheduled",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/01aeb693-138d-49d2-9403-c4f52d7d3d62')]",
      "properties": {
        "alertRuleTemplateName": "01aeb693-138d-49d2-9403-c4f52d7d3d62",
        "author": "Sander Wiebing",
        "customDetails": null,
        "date": "2020/05/23",
        "description": "Detects usage of the netsh command to open and allow connections to port 3389 (RDP). As seen used by Sarwent Malware",
        "displayName": "RDP Connection Allowed Via Netsh.EXE",
        "enabled": true,
        "entityMappings": null,
        "eventGroupingSettings": {
          "aggregationKind": "SingleAlert"
        },
        "logsource": {
          "category": "process_creation",
          "product": "windows"
        },
        "modified": "2023/12/11",
        "query": "DeviceProcessEvents\n| where ((ProcessCommandLine contains \"portopening\" or ProcessCommandLine contains \"allow\") and (ProcessCommandLine contains \"firewall \" and ProcessCommandLine contains \"add \" and ProcessCommandLine contains \"tcp \" and ProcessCommandLine contains \"3389\")) and (FolderPath endswith \"\\\\netsh.exe\" or ProcessVersionInfoOriginalFileName =~ \"netsh.exe\")",
        "queryFrequency": "P1D",
        "queryPeriod": "P1D",
        "sentinelEntitiesMappings": null,
        "severity": "high",
        "status": "test",
        "suppressionDuration": "PT5H",
        "suppressionEnabled": false,
        "tactics": null,
        "techniques": [
          "t1562"
        ],
        "templateVersion": "1.0.0",
        "triggerThreshold": 0
      },
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules"
    }
  ]
}
