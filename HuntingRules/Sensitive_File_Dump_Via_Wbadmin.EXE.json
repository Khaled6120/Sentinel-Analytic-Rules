{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "workspace": {
      "type": "String"
    }
  },
  "resources": [
    {
      "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
      "apiVersion": "2020-08-01",
      "name": "[concat(parameters('workspace'), '/Sensitive_File_Dump_Via_Wbadmin.EXE')]",
      "location": "[resourceGroup().location]",
      "properties": {
        "eTag": "*",
        "displayName": "Sensitive File Dump Via Wbadmin.EXE",
        "category": "Hunting Queries",
        "query": "DeviceProcessEvents\n| where (ProcessCommandLine contains \"start\" or ProcessCommandLine contains \"backup\") and (FolderPath endswith \"\\\\wbadmin.exe\" or ProcessVersionInfoOriginalFileName =~ \"WBADMIN.EXE\") and (ProcessCommandLine contains \"\\\\config\\\\SAM\" or ProcessCommandLine contains \"\\\\config\\\\SECURITY\" or ProcessCommandLine contains \"\\\\config\\\\SYSTEM\" or ProcessCommandLine contains \"\\\\Windows\\\\NTDS\\\\NTDS.dit\")",
        "version": 1,
        "tags": [
          {
            "name": "description",
            "value": "Detects the dump of highly sensitive files such as \"NTDS.DIT\" and \"SECURITY\" hive.\nAttackers can leverage the \"wbadmin\" utility in order to dump sensitive files that might contain credential or sensitive informatio"
          },
          {
            "name": "tactics",
            "value": "CredentialAccess"
          },
          {
            "name": "relevantTechniques",
            "value": "T1003"
          }
        ]
      }
    }
  ]
}
